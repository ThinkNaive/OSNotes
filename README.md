# OSNotes

æ“ä½œç³»ç»Ÿè¯¾ç¨‹ç¬”è®°ï¼Œè®°å½•è‡ª[ç»¿å¯¼å¸ˆåŸè°…ä½ äº†](https://space.bilibili.com/202224425/channel/collectiondetail?sid=192498)

ç¯å¢ƒä¸é¢„å…ˆæ‰§è¡Œçš„å‘½ä»¤
- ç¯å¢ƒä¸º `WSL2 Ubuntu on Windows 10`
- `sudo apt install python3`
- `sudo apt install graphviz`
- `pip3 install -r requirements.txt`

## 1. æ“ä½œç³»ç»Ÿæ¦‚è¿°

æ“ä½œç³»ç»Ÿ=å¯¹è±¡+API(åº”ç”¨è§†è§’/è®¾è®¡)=Cç¨‹åº(ç¡¬ä»¶è§†è§’/å®ç°)

## 2. ç¨‹åºå’Œç¼–è¯‘å™¨

ç¨‹åºå°±æ˜¯çŠ¶æ€æœºï¼Œä¾‹å¦‚æ±‰è¯ºå¡”

Cç¨‹åºçš„çŠ¶æ€æœºæ¨¡å‹
- çŠ¶æ€=stack frame=ASM(å†…å­˜M,å¯„å­˜å™¨R)
- å‡½æ•°è°ƒç”¨=åˆ›å»ºæ–°çš„æ ˆå¸§
- å‡½æ•°è¿”å›=åˆ é™¤æ ˆé¡¶çš„æ ˆå¸§

ç¨‹åºè¿è¡Œæµç¨‹ï¼šå–æŒ‡ä»¤ï¼Œè¯‘ç ï¼Œæ‰§è¡Œï¼Œç”Ÿæˆæ–°çš„çŠ¶æ€

æŒ‡ä»¤æœ‰ä¸¤ç§ï¼šè®¡ç®—å’Œ `syscall`

æ„é€ æœ€å°çš„ `Hello World`

- `objdump -d ${PROG}` åæ±‡ç¼–å‘½ä»¤
- `gdb` æŒ‡ä»¤
  - `starti` ä»ç¬¬ä¸€è¡Œæ‰§è¡Œ
  - `layout asm` åˆ‡æ¢åˆ°æ±‡ç¼–è§†å›¾
- ç¤ºä¾‹ä»£ç  [`minimum_hello.S`](minimum_hello.S)

ç¼–è¯‘å™¨ä¼˜åŒ–çš„æ­£ç¡®æ€§
- é™¤äº†ä¸å¯ä¼˜åŒ–çš„éƒ¨åˆ†ï¼Œéƒ½å¯ä»¥ä¼˜åŒ–
- ä¸å¯ä¼˜åŒ–æŒ‡å…¨å±€å˜é‡ã€`volatile`ã€æ±‡ç¼–ç­‰

ç¨‹åºçš„åˆå§‹çŠ¶æ€
- `gdb` çš„ `starti` å‘½ä»¤æ‰“å°çš„ç¬¬ä¸€æ¡ä¿¡æ¯ï¼Œä¾‹å¦‚ `0x0000000000401000 in _start ()`
- `info proc mappings` æ‰“å°è¿›ç¨‹å†…å­˜
- `strace ${PROG}` è·Ÿè¸ªç¨‹åºæ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨

åº”ç”¨è§†è§’çš„æ“ä½œç³»ç»Ÿ
- å°±æ˜¯ä¸€æ¡ `syscall` æŒ‡ä»¤

## 3. å¤šå¤„ç†å™¨ç¼–ç¨‹

å¹¶å‘çš„åŸºæœ¬å•ä½ï¼šçº¿ç¨‹
- å…±äº«å†…å­˜çš„å¤šä¸ªæ‰§è¡Œæµï¼ˆæ‹¥æœ‰ç‹¬ç«‹çš„æ ˆå¸§ï¼‰
- ç¤ºä¾‹ä»£ç  [`multi_thread.c`](multi_thread.c)

å®ç°åŸå­æ€§
- é—®é¢˜ï¼šå¤šå‘å°„ä¸ä¹±åºæ‰§è¡Œå¯¼è‡´çŠ¶æ€æœºæ— æ³•åˆ°è¾¾çš„çŠ¶æ€
  - ç¤ºä¾‹ä»£ç  [`mem-ordering.c`](mem-ordering.c)ï¼Œè§`18`å’Œ`30`è¡Œ
  - æ±‡ç¼–ä»£ç è¢«å¤„ç†å™¨ç¼–è¯‘ä¸ºæ›´å°çš„$\mu\rm{ops}$ï¼Œæ¯ä¸ª$\mu\rm{op}$åŒ…å«Fetch, Issue, Execute, Commitå››ä¸ªé˜¶æ®µ
  - æ¯ä¸€å‘¨æœŸå°½å¯èƒ½å¤šçš„è¡¥å……$\mu\rm{op}$ï¼ŒæŒ‡ä»¤æŒ‰æœ‰å‘æ— ç¯å›¾çš„æ‹“æ‰‘åºè¿›è¡Œä¹±åºæ‰§è¡Œã€æŒ‰åºæäº¤

## 4. å¹¶å‘ç¨‹åºæ‰§è¡Œä¸æ¨¡å‹æ£€éªŒ

æ­£ç¡®æ€§ä¸æ˜çš„å¥‡æ€ªå°è¯•ï¼ˆPetersonç®—æ³•ï¼‰
- Aå’ŒBäº‰ç”¨å•æ‰€åŒ…é—´ï¼Œç¤ºä¾‹ä»£ç [`peterson-simple.c`](peterson-simple.c)ä¼šå‡ºé”™ï¼Œæ­£ç¡®çš„ä»£ç [`peterson-barrier.c`](peterson-barrier.c)
  - æƒ³è¿›å…¥åŒ…é—´ä¹‹å‰ï¼ŒAå’ŒBéƒ½è¦å…ˆä¸¾èµ·è‡ªå·±çš„æ——å­
    - Aç¡®è®¤æ——å­ä¸¾å¥½åï¼Œå¾€å•æ‰€é—¨è´´ä¸Šâ€œBæ­£åœ¨ä½¿ç”¨â€çš„æ ‡ç­¾
    - Bç¡®è®¤æ——å­ä¸¾å¥½åï¼Œå¾€å•æ‰€é—¨è´´ä¸Šâ€œAæ­£åœ¨ä½¿ç”¨â€çš„æ ‡ç­¾
  - ç„¶åï¼Œå¦‚æœå¯¹æ–¹æ——å­ä¸¾èµ·ï¼Œä¸”é—¨ä¸Šåå­—ä¸æ˜¯è‡ªå·±
    - ç­‰å¾…
    - å¦åˆ™è¿›å…¥åŒ…é—´
  - å‡ºåŒ…é—´åï¼Œæ”¾ä¸‹è‡ªå·±çš„æ——å­
- æ­£ç¡®çš„å‰ææ˜¯ä½¿ç”¨Sequentialå†…å­˜æ¨¡å‹

å¹´è½»äººçš„ç¬¬ä¸€ä¸ªModel Checker
  ```
  python3 model-checker.py mutex-bad.py | python3 visualize.py > a.html
  python3 model-checker.py peterson-flag.py | python3 visualize.py -t > a.html
  python3 model-checker.py dekker.py | python3 visualize.py -r > a.html
  ```

## 5. å¹¶å‘æ§åˆ¶ï¼šäº’æ–¥

å®ç°äº’æ–¥çš„æ ¹æœ¬å›°éš¾ï¼šä¸èƒ½åŒæ—¶è¯»/å†™å…±äº«å†…å­˜ï¼ˆå¹¶å‘çš„å‡è®¾ï¼‰
- `load` æ—¶ä¸èƒ½å†™ï¼Œçœ‹åˆ°çš„ä¸œè¥¿é©¬ä¸Šè¿‡æ—¶äº†
- `store` æ—¶ä¸èƒ½è¯»ï¼Œåªèƒ½é—­ç€çœ¼ç›åŠ¨æ‰‹
- åŸå­æŒ‡ä»¤æ¨¡å‹
  - ä¿è¯ä¹‹å‰çš„ `store` éƒ½å†™å…¥å†…å­˜
  - ä¿è¯ `load` / `store` ä¸ä¸åŸå­æŒ‡ä»¤ä¹±åº

è‡ªæ—‹é” (`Spin Lock`)
- `xchg` ä»ç¡¬ä»¶å±‚é¢å®ç°åŸå­çš„äº¤æ¢æŒ‡ä»¤
- ä½¿ç”¨ `xchg` å®ç°äº’æ–¥ï¼šå¤šä¸ªå­¦ç”Ÿä¸Šå•æ‰€é—®é¢˜
  - åˆå§‹æ—¶ï¼Œå•æ‰€é—¨å£æ¡Œå­ä¸Šæ”¾æŠŠğŸ”‘
  - æƒ³ä¸Šå•æ‰€çš„åŒå­¦
    - é—­çœ¼ä½¿ç”¨ `xchg` ç”¨æ‰‹é‡Œçš„ğŸ”äº¤æ¢æ¡Œå­ä¸Šçš„ä¸œè¥¿
    - ççœ¼çœ‹åˆ°æ‰‹å¤´æœ‰ğŸ”‘æ‰èƒ½è¿›å•æ‰€
  - å‡ºå•æ‰€çš„åŒå­¦
    - æŠŠğŸ”‘æ”¾åˆ°æ¡Œä¸Š
- ç¼ºé™·
  - ä¼šè§¦å‘å¤„ç†å™¨é—´çš„ç¼“å­˜åŒæ­¥ï¼Œå»¶è¿Ÿå¢åŠ 
  - è·å¾—è‡ªæ—‹é”çš„çº¿ç¨‹è¢«ç³»ç»Ÿåˆ‡æ¢å‡ºå»ï¼Œ100%èµ„æºæµªè´¹
- ä½¿ç”¨åœºæ™¯
  - è¿›å…¥ä¸´ç•ŒåŒºçš„æ—¶é—´å¾ˆçŸ­
  - æŒæœ‰è‡ªæ—‹é”æ—¶ç¦æ­¢æ‰§è¡Œæµåˆ‡æ¢
- å®ç°
  - ç­‰å¾…æ—¶è®©ç»™å…¶ä»–çº¿ç¨‹
  - æŠŠé”çš„å®ç°æ”¾åˆ°æ“ä½œç³»ç»Ÿ
    - `syscall(SYSCALL_lock, &lk)`
      - å¦‚æœå¤±è´¥ï¼Œåˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹
    - `syscall(SYSCALL_unlock, &lk)`
      - é‡Šæ”¾é”ï¼Œå¦‚æœå…¶ä»–çº¿ç¨‹åœ¨ç­‰å¾…åˆ™å”¤é†’

RISC-Vå¦‚ä½•ä¿è¯å†…å­˜ä¸€è‡´æ€§ï¼šLoad-Reserved/Store-Reserved
- LR: è¯»çš„æ—¶å€™åŠ ä¸ªReservedæ ‡è®°ï¼Œå¦‚æœæœ‰ä¸­æ–­/å…¶ä»–å¤„ç†å™¨è®¿é—®åˆ™æ­¤æ ‡è®°è¢«å–æ¶ˆ
- SR: å½“Reservedæ ‡è®°å­˜åœ¨æ—¶å¯ä»¥å†™å…¥

Scalability: æ€§èƒ½çš„æ–°ç»´åº¦
- éšç€çº¿ç¨‹å¢åŠ å¯¼è‡´çš„æ€§èƒ½å˜å·®é—®é¢˜ï¼Œè§ç¤ºä¾‹ä»£ç [`sum-scalability.c`](sum-scalability.c)

äº’æ–¥é”çš„åˆ†ç±»
- è‡ªæ—‹é”ï¼ˆçº¿ç¨‹ç›´æ¥å…±äº«lockedï¼‰
  - æ›´å¿«çš„fast path
    - `xchg` æˆåŠŸ`->`ç«‹å³è¿›å…¥ä¸´ç•ŒåŒºï¼Œå¼€é”€å°
  - æ›´æ…¢çš„slow path
    - `xchg` å¤±è´¥`->`æµªè´¹CPUè‡ªæ—‹ç­‰å¾…
- ç¡çœ é”ï¼ˆé€šè¿‡ç³»ç»Ÿè°ƒç”¨è®¿é—®lockedï¼‰
  - æ›´å¿«çš„slow path
    - ä¸Šé”å¤±è´¥æ—¶çº¿ç¨‹ä¸å†å ç”¨CPU
  - æ›´æ…¢çš„fast path
    - å³ä½¿ä¸Šé”æˆåŠŸä¹Ÿè¦è¿›å‡ºå†…æ ¸ `syscall`

`Futex=Spin+Mutex`
  - ä½¿ç”¨è‡ªæ—‹é”å’Œç¡çœ é”
  - Fast path: ä¸Šé”æˆåŠŸç«‹å³è¿”å›
  - Slow path: å¦‚æœå‰é¢ä¸Šé”å¤±è´¥ï¼Œæ‰§è¡Œç³»ç»Ÿè°ƒç”¨ç¡çœ 
  - è§ç¤ºä¾‹ä»£ç [`sum-scalability.c`](sum-scalability.c)ï¼Œä¿®æ”¹ä¸º `#define FUTEX`

## 6. å¹¶å‘æ§åˆ¶ï¼šåŒæ­¥

**é—®é¢˜ï¼šå¦‚ä½•åœ¨å¤šå¤„ç†å™¨ä¸ŠååŒå¤šä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡ï¼Ÿ**

æ¡ä»¶å˜é‡ï¼ˆConditional Variablesï¼ŒCVï¼‰
- `wait(cv, mutex)`
  - è°ƒç”¨æ—¶å¿…é¡»ä¿è¯å·²ç»è·å¾—mutex
  - é‡Šæ”¾mutexï¼Œè¿›å…¥ç¡çœ çŠ¶æ€
- `signal/notify(cv)`
  - å¦‚æœæœ‰çº¿ç¨‹æ­£åœ¨ç­‰å¾…cvï¼Œåˆ™å”¤é†’å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹
- `broadcast/notifyAll(cv)`
  - å”¤é†’å…¨éƒ¨æ­£åœ¨ç­‰å¾…cvçš„çº¿ç¨‹
- ç¤ºä¾‹ä»£ç è§[`pc-cv.c`](pc-cv.c)
- æ­£ç¡®æ‰“å¼€æ–¹å¼
    ```
    mutex_lock(&lk);
    while (!cond) {
      wait(&cv, &lk); // ç­‰å¾…cvå¹¶é‡Šæ”¾lk
    }
    assert(cond);
    broadcast(&cv); // å”¤é†’å…¶ä»–å¯èƒ½æ»¡è¶³æ¡ä»¶çš„çº¿ç¨‹
    mutex_unlock(&lk);
    ```

ä¿¡å·é‡
- ç¤ºä¾‹ä»£ç è§[`pc-sem.c`](pc-sem.c)
- åœ¨â€œä¸€å•ä½èµ„æºâ€æ˜ç¡®çš„é—®é¢˜ä¸Šæ›´å¥½ç”¨

å“²å­¦å®¶åƒé¥­é—®é¢˜
- å½“å·¦å³æ‰‹å‰å­éƒ½ç©ºé—²æ—¶æ‰è·å–

åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¸¸è§çš„è§£å†³æ€è·¯
- æœåŠ¡å‘˜ç»Ÿä¸€ç®¡ç†èµ„æºçš„åˆ†é…
- ä»»åŠ¡é˜Ÿåˆ—å¯ä»¥å®ç°å‡ ä¹ä»»ä½•å¹¶è¡Œç®—æ³•

## 7. çœŸå®ä¸–ç•Œçš„å¹¶å‘ç¼–ç¨‹

é«˜æ€§èƒ½è®¡ç®—çš„å¹¶å‘ç¼–ç¨‹
- ä»¥è®¡ç®—ä¸ºä¸­å¿ƒï¼Œä¾‹å¦‚é¢„æµ‹ã€æ¨¡æ‹Ÿã€AIã€æŒ–çŸ¿
- è®¡ç®—ä»»åŠ¡çš„åˆ†è§£ï¼ˆ**æ³¨é‡ä»»åŠ¡åˆ†è§£**ï¼‰
  - è®¡ç®—å›¾-æ‹“æ‰‘æ’åº
  - ä¿¡æ¯ä¼ é€’æ¥å£MPIã€OpenMPç­‰
  - å¹¶å‘ç”»å›¾ï¼Œç¤ºä¾‹ä»£ç è§[`mandelbrot.c`](mandelbrot.c)

æ•°æ®ä¸­å¿ƒä¸­çš„å¹¶å‘ç¼–ç¨‹
- ä»¥æ•°æ®(å­˜å‚¨)ä¸ºä¸­å¿ƒï¼ˆ**æ³¨é‡ç³»ç»Ÿè°ƒç”¨**ï¼‰
- ä¸»è¦æŒ‘æˆ˜ï¼šå¤šå‰¯æœ¬æƒ…å†µä¸‹çš„é«˜å¯é ã€ä½å»¶è¿Ÿæ•°æ®è®¿é—®
  - æ•°æ®è¦ä¿æŒä¸€è‡´
  - æ—¶åˆ»ä¿æŒå¯ç”¨
  - å®¹å¿æœºå™¨ç¦»çº¿
- Goå’ŒGoroutineï¼šå¹¶è¡Œå’Œå¹¶å‘å…¨éƒ½è¦
  - æ¯ä¸ªCPUç»‘å®šä¸€ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰ä»»æ„å¤šçš„åç¨‹
  - æ¯ä¸ªçº¿ç¨‹æ‰§è¡Œåˆ°blocking APIæ—¶ï¼ˆä¾‹å¦‚sleepï¼Œscanfï¼‰
    - æˆåŠŸ`->`ç«‹å³ç»§ç»­æ‰§è¡Œå½“å‰åç¨‹
    - å¤±è´¥`->`ç«‹å³yieldåˆ°å¦ä¸€ä¸ªå¯è¿è¡Œçš„åç¨‹
  - ä½¿CPUåˆ©ç”¨ç‡è¾¾åˆ°100%
  - ä½¿ç”¨streamæµå®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹
    ```
    stream <- x
    y := <- stream
    ```

äººæœºäº¤äº’ç¨‹åº
- ä¸å¤ªå¤æ‚ï¼Œæ—¢æ²¡å¤ªå¤šè®¡ç®—ï¼Œä¹Ÿæ²¡å¤ªå¤šIOï¼ˆ**æ³¨é‡æ˜“ç”¨æ€§**ï¼‰
- ç½‘é¡µæµè§ˆå™¨/ç§»åŠ¨åº”ç”¨é‡‡ç”¨å¼‚æ­¥äº‹ä»¶æ¨¡å‹
  - æ˜¯ä¸€ç§å¹¶å‘æ¨¡å‹ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨
  - APIæ¯”å¦‚httpgetä»ç„¶å¯ä»¥å¹¶è¡Œ
  - Async-Await
    - async function
      - æ€»æ˜¯è¿”å›ä¸€ä¸ªPromise object
    - await promise
      ```
      `promise.then(...)`
      ```

## 8. å¹¶å‘BUGå’Œåº”å¯¹

åº”å¯¹å¹¶å‘BUGçš„æ–¹æ³•
- è½¯ä»¶æ˜¯éœ€æ±‚åœ¨è®¡ç®—æœºæ•°å­—ä¸–ç•Œä¸­çš„æŠ•å½±
- BUGå¤šçš„æ ¹æœ¬åŸå› ï¼šç¼–ç¨‹è¯­è¨€çš„ç¼ºé™·
- å®åœ¨çš„æ–¹æ³•ï¼šé˜²å¾¡æ€§ç¼–ç¨‹
  - åŠ æ–­è¨€ï¼ŒåŠ æ£€æŸ¥

å¹¶å‘BUGï¼šæ­»é”ï¼ˆDeadlockï¼‰
- å‡ºç°çº¿ç¨‹äº’ç›¸ç­‰å¾…çš„æƒ…å†µ
  - AA-Deadlock
    - ä¸€ä¸ªçº¿ç¨‹è‡ªå·±ç­‰å¾…è‡ªå·±
    - åœ¨ä¸åŒçš„å‡½æ•°ä¸­æŒæœ‰å¹¶ç­‰å¾…
  - ABBA-Deadlock
    - ä¸Šé”é¡ºåºå¯¼è‡´æŒæœ‰å¹¶ç­‰å¾…ï¼Œä¾‹å¦‚å“²å­¦å®¶åƒé¥­
- é¿å…æ­»é”
  - æ­»é”äº§ç”Ÿçš„å¿…è¦æ¡ä»¶
    - äº’æ–¥ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨
    - è¯·æ±‚ä¸ä¿æŒï¼šè¯·æ±‚é˜»å¡æ—¶ï¼Œä¸é‡Šæ”¾å·²ç»è·å¾—çš„èµ„æº
    - ä¸å‰¥å¤ºï¼šå·²è·å¾—èµ„æºä¸èƒ½è¢«å¼ºè¡Œå‰¥å¤º
    - å¾ªç¯ç­‰å¾…ï¼šè¿›ç¨‹é—´å½¢æˆå¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»
  - AA-Deadlock
    - ç¤ºä¾‹ä»£ç [`spinlock-xv6.c`](spinlock-xv6.c)ä¸­çš„é˜²å¾¡æ€§ç¼–ç¨‹
      ```
      push_off(); // ç¦æ­¢ä¸­æ–­é¿å…æ­»é”
      if(holding(lk)) panic("acquire");
      ```
  - ABBA-Deadlock
    - ä¸¥æ ¼æŒ‰ç…§å›ºå®šé¡ºåºè·å–é”
    - ç¤ºä¾‹ä»£ç è§[`lock-ordering.py`](lock-ordering.py)
      ```
      python3 model-checker.py lock-ordering.py | python3 visualize.py > a.html
      ```

å¹¶å‘BUGï¼šæ•°æ®ç«äº‰ï¼ˆData Raceï¼‰
- ä¸åŒçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€æ®µå†…å­˜ï¼Œä¸”è‡³å°‘æœ‰ä¸€ä¸ªå†™
- ç”¨äº’æ–¥é”ä¿æŠ¤å¥½å…±äº«æ•°æ®
- å®ç°å¹¶å‘æ§åˆ¶çš„å·¥å…·
  - äº’æ–¥é”ï¼ˆlock/unlockï¼‰ï¼šåŸå­æ€§
  - æ¡ä»¶å˜é‡ï¼ˆwait/signalï¼‰ï¼šåŒæ­¥
- é”™è¯¯ç±»å‹
  - å¿˜è®°ä¸Šé”â€”â€”åŸå­æ€§è¿åï¼ˆAtomicity Violationï¼ŒAVï¼‰
    ```
    Thread1                   Thread2
    S1: if (t->info) -------â†˜
    {                         S3: t->info = NULL;
      S2: do(t->info); â†----â†™
    }
    ```
  - å¿˜è®°åŒæ­¥â€”â€”é¡ºåºè¿åï¼ˆOrder Violationï¼ŒOVï¼‰
    ```
    Thread1                   Thread2
    S1: call_thread2(); ----â†˜
                              S4: done = True;
    S2: done = False; â†-----â†™
    S3: while (!done) {}
    ```

## 9. æ“ä½œç³»ç»Ÿçš„çŠ¶æ€æœºæ¨¡å‹

